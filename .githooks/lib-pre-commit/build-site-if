#!/bin/bash

set -e

# Status helper function
status() {
    if [ $? -eq 0 ]; then
        echo "✅ $1"
    else
        echo "❌ $1"
        return 1
    fi
}

echo "Checking for site build trigger in environment..."

# Check if BUILD_SITE environment variable is set to true
if [[ "$BUILD_SITE" == "true" ]]; then
    echo "🔨 BUILD_SITE=true detected, building site..."
    
    # Change to site directory
    cd site/leptos-bevy
    
    # Build the site
    echo "📦 Building site with Trunk..."
    trunk build --release
    status "Site build completed"
    
    # Copy redirects file to dist
    echo "📋 Copying redirects file to dist..."
    cp _redirects dist/
    status "Redirects file copied"
    
    # Create dist.zip
    echo "📦 Creating dist.zip..."
    cd dist
    zip -r ../dist.zip . -q
    cd ..
    status "dist.zip created"
    
    # Add dist.zip to git
    echo "📝 Adding dist.zip to git..."
    git add dist.zip
    status "dist.zip added to git"
    
    echo "✅ Site build and packaging completed!"
else
    echo "⏭️  BUILD_SITE not set to true, skipping site build"
fi
