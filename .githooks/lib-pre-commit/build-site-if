#!/bin/bash

set -e

# Status helper function
status() {
    if [ $? -eq 0 ]; then
        echo "âœ… $1"
    else
        echo "âŒ $1"
        return 1
    fi
}

echo "Checking for site build trigger in commit message..."

# Get the commit message from the current commit being made
# We need to check if the commit message contains the build trigger
# Since we're in pre-commit, we can check the commit message file
COMMIT_MSG_FILE=".git/COMMIT_EDITMSG"
if [ ! -f "$COMMIT_MSG_FILE" ]; then
    # If the file doesn't exist, we're probably not in a commit context
    # Check if we can get the message from git
    if ! COMMIT_MSG=$(git log -1 --pretty=%B 2>/dev/null); then
        echo "â­ï¸  No commit message found, skipping site build check"
        exit 0
    fi
else
    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
fi

# Check if commit message contains the build trigger pattern
# Acceptable patterns:
# - ci(pre-commit: build-site-if): <message>
# - ci(buildem): <message>
if [[ "$COMMIT_MSG" =~ ci\(pre-commit:\ build-site-if\): || "$COMMIT_MSG" =~ ci\(buildem\): ]]; then
    echo "ğŸ”¨ Commit message contains build trigger, building site..."
    
    # Change to site directory
    cd site/leptos-bevy
    
    # Build the site
    echo "ğŸ“¦ Building site with Trunk..."
    trunk build --release
    status "Site build completed"
    
    # Copy redirects file to dist
    echo "ğŸ“‹ Copying redirects file to dist..."
    cp _redirects dist/
    status "Redirects file copied"
    
    # Create dist.zip
    echo "ğŸ“¦ Creating dist.zip..."
    cd dist
    zip -r ../dist.zip . -q
    cd ..
    status "dist.zip created"
    
    # Add dist.zip to git
    echo "ğŸ“ Adding dist.zip to git..."
    git add dist.zip
    status "dist.zip added to git"
    
    echo "âœ… Site build and packaging completed!"
else
    echo "â­ï¸  No build trigger found in commit message, skipping site build"
fi
