#!/bin/bash

set -e

# Status helper function
status() {
    if [ $? -eq 0 ]; then
        echo "âœ… $1"
    else
        echo "âŒ $1"
        return 1
    fi
}

echo "Running commit-msg hook: Checking for site build trigger..."

# Get commit message from the file passed as argument
COMMIT_MSG_FILE="$1"
if [ ! -f "$COMMIT_MSG_FILE" ]; then
    echo "âŒ Commit message file not found: $COMMIT_MSG_FILE"
    exit 1
fi

COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Check if commit message contains the build trigger pattern
if [[ "$COMMIT_MSG" =~ ci\(pre-commit:\ build-site-if\): ]]; then
    echo "ğŸ”¨ Commit message contains build trigger, building site..."
    
    # Change to site directory
    cd site/leptos-bevy
    
    # Build the site
    echo "ğŸ“¦ Building site with Trunk..."
    trunk build --release
    status "Site build completed"
    
    # Copy redirects file to dist
    echo "ğŸ“‹ Copying redirects file to dist..."
    cp _redirects dist/
    status "Redirects file copied"
    
    # Create dist.zip
    echo "ğŸ“¦ Creating dist.zip..."
    cd dist
    zip -r ../dist.zip . -q
    cd ..
    status "dist.zip created"
    
    # Add dist.zip to git
    echo "ğŸ“ Adding dist.zip to git..."
    git add dist.zip
    status "dist.zip added to git"
    
    echo "âœ… Site build and packaging completed!"
else
    echo "â­ï¸  No build trigger found in commit message, skipping site build"
fi
